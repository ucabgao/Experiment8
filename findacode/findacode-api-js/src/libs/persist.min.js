//  Persist.js
// Copyright (c) 2008, 2009 Paul Duncan (paul@pablotron.org)
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
//
typeof FAC.deconcept=="undefined"&&(FAC.deconcept=new Object),typeof FAC.deconcept.util=="undefined"&&(FAC.deconcept.util=new Object),typeof FAC.deconcept.SWFObjectUtil=="undefined"&&(FAC.deconcept.SWFObjectUtil=new Object),FAC.deconcept.SWFObject=function(a,b,c,d,e,f,g,h,i,j){if(!document.getElementById)return;this.DETECT_KEY=j?j:"detectflash",this.skipDetect=FAC.deconcept.util.getRequestParameter(this.DETECT_KEY),this.params=new Object,this.variables=new Object,this.attributes=new Array,a&&this.setAttribute("swf",a),b&&this.setAttribute("id",b),c&&this.setAttribute("width",c),d&&this.setAttribute("height",d),e&&this.setAttribute("version",new FAC.deconcept.PlayerVersion(e.toString().split("."))),this.installedVer=FAC.deconcept.SWFObjectUtil.getPlayerVersion(),!window.opera&&document.all&&this.installedVer.major>7&&(FAC.deconcept.SWFObject.doPrepUnload=!0),f&&this.addParam("bgcolor",f);var k=g?g:"high";this.addParam("quality",k),this.setAttribute("useExpressInstall",!1),this.setAttribute("doExpressInstall",!1);var l=h?h:window.location;this.setAttribute("xiRedirectUrl",l),this.setAttribute("redirectUrl",""),i&&this.setAttribute("redirectUrl",i)},FAC.deconcept.SWFObject.prototype={useExpressInstall:function(a){this.xiSWFPath=a?a:"expressinstall.swf",this.setAttribute("useExpressInstall",!0)},setAttribute:function(a,b){this.attributes[a]=b},getAttribute:function(a){return this.attributes[a]},addParam:function(a,b){this.params[a]=b},getParams:function(){return this.params},addVariable:function(a,b){this.variables[a]=b},getVariable:function(a){return this.variables[a]},getVariables:function(){return this.variables},getVariablePairs:function(){var a=new Array,b,c=this.getVariables();for(b in c)a.push(b+"="+c[b]);return a},getSWFHTML:function(){var a="";if(navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length){this.getAttribute("doExpressInstall")&&(this.addVariable("MMplayerType","PlugIn"),this.setAttribute("swf",this.xiSWFPath)),a='<embed type="application/x-shockwave-flash" src="'+this.getAttribute("swf")+'" width="'+this.getAttribute("width")+'" height="'+this.getAttribute("height")+'"',a+=' id="'+this.getAttribute("id")+'" name="'+this.getAttribute("id")+'" ';var b=this.getParams();for(var c in b)a+=[c]+'="'+b[c]+'" ';var d=this.getVariablePairs().join("&");d.length>0&&(a+='flashvars="'+d+'"'),a+="/>"}else{this.getAttribute("doExpressInstall")&&(this.addVariable("MMplayerType","ActiveX"),this.setAttribute("swf",this.xiSWFPath)),a='<object id="'+this.getAttribute("id")+'" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="'+this.getAttribute("width")+'" height="'+this.getAttribute("height")+'">',a+='<param name="movie" value="'+this.getAttribute("swf")+'" />';var b=this.getParams();for(var c in b)a+='<param name="'+c+'" value="'+b[c]+'" />';var d=this.getVariablePairs().join("&");d.length>0&&(a+='<param name="flashvars" value="'+d+'" />'),a+="</object>"}return a},write:function(a){if(this.getAttribute("useExpressInstall")){var b=new FAC.deconcept.PlayerVersion([6,0,65]);this.installedVer.versionIsValid(b)&&!this.installedVer.versionIsValid(this.getAttribute("version"))&&(this.setAttribute("doExpressInstall",!0),this.addVariable("MMredirectURL",escape(this.getAttribute("xiRedirectUrl"))),document.title=document.title.slice(0,47)+" - Flash Player Installation",this.addVariable("MMdoctitle",document.title))}if(this.skipDetect||this.getAttribute("doExpressInstall")||this.installedVer.versionIsValid(this.getAttribute("version"))){var c=typeof a=="string"?document.getElementById(a):a;return c.innerHTML=this.getSWFHTML(),!0}return this.getAttribute("redirectUrl")!=""&&document.location.replace(this.getAttribute("redirectUrl")),!1}},FAC.deconcept.SWFObjectUtil.getPlayerVersion=function(){var a=new FAC.deconcept.PlayerVersion([0,0,0]);if(navigator.plugins&&navigator.mimeTypes.length){var b=navigator.plugins["Shockwave Flash"];b&&b.description&&(a=new FAC.deconcept.PlayerVersion(b.description.replace(/([a-zA-Z]|\s)+/,"").replace(/(\s+r|\s+b[0-9]+)/,".").split(".")))}else{try{var c=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.7")}catch(d){try{var c=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.6");a=new FAC.deconcept.PlayerVersion([6,0,21]),c.AllowScriptAccess="always"}catch(d){if(a.major==6)return a}try{c=new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(d){}}c!=null&&(a=new FAC.deconcept.PlayerVersion(c.GetVariable("$version").split(" ")[1].split(",")))}return a},FAC.deconcept.PlayerVersion=function(a){this.major=a[0]!=null?parseInt(a[0]):0,this.minor=a[1]!=null?parseInt(a[1]):0,this.rev=a[2]!=null?parseInt(a[2]):0},FAC.deconcept.PlayerVersion.prototype.versionIsValid=function(a){return this.major<a.major?!1:this.major>a.major?!0:this.minor<a.minor?!1:this.minor>a.minor?!0:this.rev<a.rev?!1:!0},FAC.deconcept.util={getRequestParameter:function(a){var b=document.location.search||document.location.hash;if(b){var c=b.substring(1).split("&");for(var d=0;d<c.length;d++)if(c[d].substring(0,c[d].indexOf("="))==a)return c[d].substring(c[d].indexOf("=")+1)}return""}},FAC.deconcept.SWFObjectUtil.cleanupSWFs=function(){var a=document.getElementsByTagName("OBJECT");for(var b=0;b<a.length;b++){a[b].style.display="none";for(var c in a[b])typeof a[b][c]=="function"&&(a[b][c]=function(){})}},FAC.deconcept.SWFObject.doPrepUnload&&(FAC.deconcept.SWFObjectUtil.prepUnload=function(){__flash_unloadHandler=function(){},__flash_savedUnloadHandler=function(){},window.attachEvent("onunload",FAC.deconcept.SWFObjectUtil.cleanupSWFs)},window.attachEvent("onbeforeunload",FAC.deconcept.SWFObjectUtil.prepUnload)),Array.prototype.push==null&&(Array.prototype.push=function(a){return this[this.length]=a,this.length}),function(){if(window.google&&google.gears)return;var a=null;if(typeof GearsFactory!="undefined")a=new GearsFactory;else try{a=new ActiveXObject("Gears.Factory"),a.getBuildInfo().indexOf("ie_mobile")!=-1&&a.privateSetGlobalObject(this)}catch(b){typeof navigator.mimeTypes!="undefined"&&navigator.mimeTypes["application/x-googlegears"]&&(a=document.createElement("object"),a.style.display="none",a.width=0,a.height=0,a.type="application/x-googlegears",document.documentElement.appendChild(a))}if(!a)return;window.google||(google={}),google.gears||(google.gears={factory:a})}(),FAC.persist=function(){var a="0.3.0",b,c,d,e,f,g;g=function(){var a="Thu, 01-Jan-1970 00:00:01 GMT",b=864e5,c=["expires","path","domain"],d=escape,e=unescape,f=document,g,h=function(){var a=new Date;return a.setTime(a.getTime()),a},i=function(a,b){var e,f,g,h=[],i=arguments.length>2?arguments[2]:{};h.push(d(a)+"="+d(b));for(var j=0;j<c.length;j++)f=c[j],g=i[f],g&&h.push(f+"="+g);return i.secure&&h.push("secure"),h.join("; ")},j=function(){var a="__EC_TEST__",b=new Date;return b=b.toGMTString(),this.set(a,b),this.enabled=this.remove(a)==b,this.enabled};return g={set:function(a,c){var d=arguments.length>2?arguments[2]:{},e=h(),g,j={};if(d.expires){var k=d.expires*b;j.expires=new Date(e.getTime()+k),j.expires=j.expires.toGMTString()}var l=["path","domain","secure"];for(var m=0;m<l.length;m++)d[l[m]]&&(j[l[m]]=d[l[m]]);var n=i(a,c,j);return f.cookie=n,c},has:function(a){a=d(a);var b=f.cookie,c=b.indexOf(a+"="),e=c+a.length+1,g=b.substring(0,a.length);return!c&&a!=g||c<0?!1:!0},get:function(a){a=d(a);var b=f.cookie,c=b.indexOf(a+"="),g=c+a.length+1,h=b.substring(0,a.length),i;return!c&&a!=h||c<0?null:(i=b.indexOf(";",g),i<0&&(i=b.length),e(b.substring(g,i)))},remove:function(b){var c=g.get(b),d={expires:a};return f.cookie=i(b,"",d),c},keys:function(){var a=f.cookie,b=a.split("; "),c,d,g=[];for(var h=0;h<b.length;h++)d=b[h].split("="),g.push(e(d[0]));return g},all:function(){var a=f.cookie,b=a.split("; "),c,d,g=[];for(var h=0;h<b.length;h++)d=b[h].split("="),g.push([e(d[0]),e(d[1])]);return g},version:"0.2.1",enabled:!1},g.enabled=j.call(g),g}();var h=function(){return Array.prototype.indexOf?function(a,b){return Array.prototype.indexOf.call(a,b)}:function(a,b){var c,d;for(var e=0,f=a.length;e<f;e++)if(a[e]==b)return e;return-1}}();f=function(){},d=function(a){return"PS"+a.replace(/_/g,"__").replace(/ /g,"_s")};var j={search_order:["localstorage","globalstorage","gears","cookie","ie","flash"],name_re:/^[a-z][a-z0-9_ \-]+$/i,methods:["init","get","set","remove","load","save","iterate"],sql:{version:"1",create:"CREATE TABLE IF NOT EXISTS persist_data (k TEXT UNIQUE NOT NULL PRIMARY KEY, v TEXT NOT NULL)",get:"SELECT v FROM persist_data WHERE k = ?",set:"INSERT INTO persist_data(k, v) VALUES (?, ?)",remove:"DELETE FROM persist_data WHERE k = ?",keys:"SELECT * FROM persist_data"},flash:{div_id:"_persist_flash_wrap",id:"_persist_flash",path:"persist.swf",size:{w:1,h:1},args:{autostart:!0}}};return c={gears:{size:-1,test:function(){return window.google&&window.google.gears?!0:!1},methods:{init:function(){var a;a=this.db=google.gears.factory.create("beta.database"),a.open(d(this.name)),a.execute(j.sql.create).close()},get:function(a){var b,c=j.sql.get,d=this.db,e;return d.execute("BEGIN").close(),b=d.execute(c,[a]),e=b.isValidRow()?b.field(0):null,b.close(),d.execute("COMMIT").close(),e},set:function(a,b){var c=j.sql.remove,d=j.sql.set,e,f=this.db,g;return f.execute("BEGIN").close(),f.execute(c,[a]).close(),f.execute(d,[a,b]).close(),f.execute("COMMIT").close(),b},remove:function(a){var b=j.sql.get;sql=j.sql.remove,r,val=null,is_valid=!1;var c=this.db;return c.execute("BEGIN").close(),c.execute(sql,[a]).close(),c.execute("COMMIT").close(),!0},iterate:function(a,b){var c=j.sql.keys,d,e=this.db;d=e.execute(c);while(d.isValidRow())a.call(b||this,d.field(0),d.field(1)),d.next();d.close()}}},globalstorage:{size:5242880,test:function(){if(!window.globalStorage)return!1;var a="127.0.0.1";this.o&&this.o.domain&&(a=this.o.domain);try{var b=globalStorage[a];return!0}catch(c){return window.console&&window.console.warn&&console.warn("globalStorage exists, but couldn't use it because your browser is running on domain:",a),!1}},methods:{key:function(a){return d(this.name)+d(a)},init:function(){this.store=globalStorage[this.o.domain]},get:function(a){return a=this.key(a),this.store.getItem(a)},set:function(a,b){return a=this.key(a),this.store.setItem(a,b),b},remove:function(a){var b;return a=this.key(a),b=this.store.getItem[a],this.store.removeItem(a),b}}},localstorage:{size:-1,test:function(){return window.localStorage?!0:!1},methods:{key:function(a){return this.name+">"+a},init:function(){this.store=localStorage},get:function(a){return a=this.key(a),this.store.getItem(a)},set:function(a,b){return a=this.key(a),this.store.setItem(a,b),b},remove:function(a){var b;return a=this.key(a),b=this.store.getItem(a),this.store.removeItem(a),b},iterate:function(a,b){var c=this.store;for(i=0;i<c.length;i++)keys=c[i].split(">"),keys.length==2&&keys[0]==this.name&&a.call(b||this,keys[1],c[c[i]])}}},ie:{prefix:"_persist_data-",size:65536,test:function(){return window.ActiveXObject?!0:!1},make_userdata:function(a){var b=document.createElement("div");return b.id=a,b.style.display="none",b.addBehavior("#default#userdata"),document.body.appendChild(b),b},methods:{init:function(){var a=c.ie.prefix+d(this.name);this.el=c.ie.make_userdata(a),this.o.defer&&this.load()},get:function(a){var b;return a=d(a),this.o.defer||this.load(),b=this.el.getAttribute(a),b},set:function(a,b){return a=d(a),this.el.setAttribute(a,b),this.o.defer||this.save(),b},remove:function(a){var b;return a=d(a),this.o.defer||this.load(),b=this.el.getAttribute(a),this.el.removeAttribute(a),this.o.defer||this.save(),b},load:function(){this.el.load(d(this.name))},save:function(){this.el.save(d(this.name))}}},cookie:{delim:":",size:4e3,test:function(){return b.Cookie.enabled?!0:!1},methods:{key:function(a){return this.name+c.cookie.delim+a},get:function(a,b){var c;return a=this.key(a),c=g.get(a),c},set:function(a,b,c){return a=this.key(a),g.set(a,b,this.o),b},remove:function(a,b){var b;return a=this.key(a),b=g.remove(a),b}}},flash:{test:function(){if(!FAC.deconcept||!FAC.deconcept.SWFObjectUtil)return!1;var a=FAC.deconcept.SWFObjectUtil.getPlayerVersion().major;return a>=8?!0:!1},methods:{init:function(){if(!c.flash.el){var a,b,d,e=j.flash;d=document.createElement("div"),d.id=e.div_id,document.body.appendChild(d),a=new FAC.deconcept.SWFObject(this.o.swf_path||e.path,e.id,e.size.w,e.size.h,"8");for(b in e.args)e.args[b]!="function"&&a.addVariable(b,e.args[b]);a.write(d),c.flash.el=document.getElementById(e.id)}this.el=c.flash.el},get:function(a){var b;return a=d(a),b=this.el.get(this.name,a),b},set:function(a,b){var c;return a=d(a),c=this.el.set(this.name,a,b),c},remove:function(a){var b;return a=d(a),b=this.el.remove(this.name,a),b}}}},e=function(){var a,d,e,g,h=j.methods,i=j.search_order;for(var k=0,l=h.length;k<l;k++)b.Store.prototype[h[k]]=f;b.type=null,b.size=-1;for(var m=0,n=i.length;!b.type&&m<n;m++){e=c[i[m]];if(e.test()){b.type=i[m],b.size=e.size;for(g in e.methods)b.Store.prototype[g]=e.methods[g]}}b._init=!0},b={VERSION:a,type:null,size:0,add:function(a){c[a.id]=a,j.search_order=[a.id].concat(j.search_order),e()},remove:function(a){var b=h(j.search_order,a);if(b<0)return;j.search_order.splice(b,1),delete c[a],e()},Cookie:g,Store:function(a,c){if(!j.name_re.exec(a))throw new Error("Invalid name");if(!b.type)throw new Error("No suitable storage found");c=c||{},this.name=a,c.domain=c.domain||location.hostname||"localhost",c.domain=c.domain.replace(/:\d+$/,""),c.domain=c.domain=="localhost"?"":c.domain,this.o=c,c.expires=c.expires||730,c.path=c.path||"/",this.init()}},e(),b}();